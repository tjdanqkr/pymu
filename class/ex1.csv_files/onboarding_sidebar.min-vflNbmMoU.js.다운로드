define(["require","exports","tslib","react-redux","react","react-dom","modules/clean/api_v2/user_client","modules/clean/css","modules/clean/react/css","modules/clean/react/growth/onboarding_sidebar/data/actions","modules/clean/react/growth/onboarding_sidebar/data/selectors","modules/clean/react/growth/onboarding_sidebar/data/store","modules/clean/react/growth/onboarding_sidebar/sidebars","modules/clean/react/growth/onboarding_sidebar/types","modules/clean/react/growth/onboarding_sidebar/util","modules/clean/react/growth/util","modules/clean/react/growth/logging_util","modules/core/exception","modules/clean/react/growth/onboarding_sidebar/onboarding_sidebar_action_tracker","modules/core/dom"],(function(e,n,o,i,t,a,r,d,s,c,b,l,u,p,S,g,m,h,f,_){"use strict";Object.defineProperty(n,"__esModule",{value:!0}),t=o.__importDefault(t),a=o.__importStar(a),_=o.__importStar(_);var I=(function(e){function n(n){var i=e.call(this,n)||this;return i.canPeek=!0,i.canUnpeek=!0,i.generateSidebarSessionId=function(){return Math.random().toString(36).substr(2,9)},i.reportException=function(e,n){S.reportOnboardingSidebarException(e,n,i.props.onboardingSidebarType)},i.logSidebarAction=function(e,n){var o=u.getProjectTypeForOnboardingType(i.props.onboardingSidebarType),t=m.ComponentName.ONBOARDING_SIDEBAR;if(o)switch(e){case"display":m.logDisplay(o,t);break;case"completed":m.logCompleted(o,t);break;case"dismissed":m.logDismiss(o,t);break;case"task_expanded":n&&m.logTaskExpanded(o,t,n)}},i.logModuleActivating=function(){var e=i.state,n=e.onboardingSidebarInfo,o=e.activeModuleIndex;if(n&&null!==o){var t=n.modules[o].name;i.logSidebarAction("task_expanded",t)}},i.handleSuccess=function(e){g.markModuleAsCompleted(i.props.userId,e);var n=i.state.onboardingSidebarInfo;try{if(n){var t=n.modules.map((function(n){var o=n;return n.name===e&&(o.is_completed=!0),o})),a=t.every((function(e){return e.is_completed})),r=o.__assign(o.__assign({},n),{is_completed:a,modules:t});return i.setState({onboardingSidebarInfo:r},(function(){i.setState({activeModuleIndex:i.getNextModuleIndex()})})),r}}catch(e){i.reportException("Onboarding sidebar was unable to update completed module",h.SEVERITY.CRITICAL)}return null},i.handleMouseEnter=function(){i.setState({isSidebarActiveOrHovered:!0})},i.handleMouseLeave=function(){i.setState({isSidebarActiveOrHovered:!1})},i.handleClickSidebar=function(){i.state.isSidebarPeeking&&i.openSidebar()},i.handleKeyDown=function(e){if(i.props.isSidebarOpen){if(27===e.keyCode)return void i.closeSidebar();_.keepFocusIn(a.findDOMNode(i.sidebarRef),e,!0)}},i.openSidebar=function(){return i.props.openOnboardingSidebar(),new Promise((function(e){setTimeout(e,p.ONBOARDING_SIDEBAR_SLIDE_DURATION)}))},i.closeSidebar=function(){return i.props.closeOnboardingSidebar(),new Promise((function(e){setTimeout(e,p.ONBOARDING_SIDEBAR_SLIDE_DURATION)}))},i.setActiveModuleIndex=function(e){var n=i.state.onboardingSidebarInfo;null===e||n&&e<n.modules.length?i.setState({activeModuleIndex:e}):i.reportException("Onboarding sidebar is attempting to activate a nonexistent module index of "+e,h.SEVERITY.NONCRITICAL)},i.renderOnboardingModules=function(){var e=i.state,n=e.onboardingSidebarInfo,a=e.OnboardingModulesComponent;return n&&a?n.modules.map((function(e,n){var r=e.name,d=e.props,s=e.is_completed,c=n===i.state.activeModuleIndex,b={};return d&&(b=S.convertObjectPropertiesToCamelCase(d)),t.default.createElement(a,o.__assign({key:i.sidebarSessionId+"-"+r,moduleName:r,handleSuccess:function(){return i.handleSuccess(r)},closeSidebar:i.closeSidebar,isCompleted:s,isActive:c},b))})):[]},i.getNextModuleIndex=function(){var e=i.state.onboardingSidebarInfo;return e?e.modules.reduce((function(e,n,o){return null!==e?e:n.is_completed?null:o}),null):null},i.setSidebarRef=function(e){i.sidebarRef=e},i.state={SidebarComponent:null,OnboardingModulesComponent:null,areComponentsLoaded:!1,onboardingSidebarInfo:null,isOnboardingSidebarInfoLoaded:!1,activeModuleIndex:null,isSidebarActiveOrHovered:!1,isSidebarPeeking:!1,hasSidebarOpened:!1},i.asyncLoadModulesInfo=i.asyncLoadModulesInfo.bind(i),i.sidebarSessionId=i.generateSidebarSessionId(),i.onboardingSidebarActionTracker=new f.OnboardingSidebarActionTracker(n.userId,{project:n.onboardingSidebarType}),i}return o.__extends(n,e),n.prototype.componentDidMount=function(){return o.__awaiter(this,void 0,void 0,(function(){var e,n=this;return o.__generator(this,(function(o){switch(o.label){case 0:return[4,this.asyncLoadComponents()];case 1:return o.sent(),[4,this.asyncLoadModulesInfo()];case 2:return o.sent(),this.props.openOnLoad&&(e=function(){return setTimeout(n.openSidebar,1e3)},"complete"===document.readyState?e():window.addEventListener("load",e)),[2]}}))}))},n.prototype.componentDidUpdate=function(e,n){var o=this,i=this.state,t=i.isOnboardingSidebarInfoLoaded,a=i.onboardingSidebarInfo,r=i.activeModuleIndex,d=i.isSidebarPeeking,s=i.isSidebarActiveOrHovered,c=i.hasSidebarOpened,b=this.props.isSidebarOpen;!e.isSidebarOpen&&b&&(this.sidebarSessionId=this.generateSidebarSessionId(),this.logSidebarAction("display"),a&&a.is_completed&&!this.hasCompleted&&(this.logSidebarAction("completed"),this.hasCompleted=!0),c||this.logModuleActivating(),document.body.style.overflow="hidden",this.setState({hasSidebarOpened:!0})),e.isSidebarOpen&&!b&&(document.body.style.overflow="",this.canPeek=!1,setTimeout((function(){o.canPeek=!0}),p.ONBOARDING_SIDEBAR_SLIDE_DURATION),this.logSidebarAction("dismissed")),b&&n.activeModuleIndex!==r&&this.logModuleActivating(),t&&!n.isOnboardingSidebarInfoLoaded?this.setState({activeModuleIndex:this.getNextModuleIndex()}):n.onboardingSidebarInfo&&a&&"number"==typeof r&&!n.onboardingSidebarInfo.modules[r].is_completed&&a.modules[r].is_completed?this.setState({activeModuleIndex:this.getNextModuleIndex()}):n.onboardingSidebarInfo&&a&&!n.onboardingSidebarInfo.is_completed&&a.is_completed&&this.setState({activeModuleIndex:this.getNextModuleIndex()}),!this.canPeek||e.isSidebarOpen||b||d||!s||(this.setState({isSidebarPeeking:!0},(function(){setTimeout((function(){o.canUnpeek=!0,o.forceUpdate()}),1e3)})),this.canUnpeek=!1),this.canUnpeek&&d&&(!s||b)&&this.setState({isSidebarPeeking:!1}),(!n.isSidebarPeeking&&!e.isSidebarOpen&&b||!n.isSidebarPeeking&&d)&&this.asyncLoadModulesInfo(),!e.isSidebarOpen&&b&&this.onboardingSidebarActionTracker.track(f.OnboardingSidebarActions.ONBOARDING_SIDEBAR_SEEN_OPEN),(n.onboardingSidebarInfo&&a&&b&&!n.onboardingSidebarInfo.is_completed&&a.is_completed||!e.isSidebarOpen&&b&&a&&a.is_completed)&&this.onboardingSidebarActionTracker.track(f.OnboardingSidebarActions.ONBOARDING_SIDEBAR_SEEN_FINISHED)},n.prototype.asyncLoadComponents=function(){return o.__awaiter(this,void 0,void 0,(function(){var e,n,i;return o.__generator(this,(function(t){switch(t.label){case 0:e=this.props.onboardingSidebarType,t.label=1;case 1:return t.trys.push([1,6,,7]),[4,u.getAsyncImportsForOnboardingType(e)()];case 2:return(n=t.sent())?(i=u.getCssPathsForOnboardingType(e),[4,d.require_css_multi(i)]):[3,4];case 3:return t.sent(),this.setState(o.__assign(o.__assign({},n),{areComponentsLoaded:!0})),[3,5];case 4:throw new Error;case 5:return[3,7];case 6:return t.sent(),this.reportException("Onboarding sidebar was unable to asynchronously load display components",h.SEVERITY.NONCRITICAL),[3,7];case 7:return[2]}}))}))},n.prototype.asyncLoadModulesInfo=function(){return o.__awaiter(this,void 0,void 0,(function(){var e,n;return o.__generator(this,(function(o){switch(o.label){case 0:e=this.props.onboardingSidebarType,o.label=1;case 1:return o.trys.push([1,3,,4]),[4,(new r.UserApiV2Client).ns("growth").rpc("get_onboarding_sidebar_info",{sidebar_type:e},{subjectUserId:this.props.userId})];case 2:return n=o.sent(),this.setState({onboardingSidebarInfo:n,isOnboardingSidebarInfoLoaded:!0}),[2];case 3:return o.sent(),this.reportException("Onboarding sidebar was unable to load sidebar info",h.SEVERITY.CRITICAL),[3,4];case 4:return[2]}}))}))},n.prototype.render=function(){var e=this.state,n=e.SidebarComponent,i=e.onboardingSidebarInfo,a=e.activeModuleIndex,r=e.isSidebarPeeking,d=this.props,s=d.openOnLoad,c=d.isSidebarOpen,b=d.isSidebarHidden;if(!i||!n)return null;var l=i.props,u=i.is_completed,p={};return l&&(p=S.convertObjectPropertiesToCamelCase(l)),t.default.createElement("div",{className:"\n        onboarding-sidebar\n        onboarding-sidebar--"+(b?"hidden":"visible")+"\n      "},t.default.createElement("div",{className:"\n            onboarding-sidebar__overlay\n            onboarding-sidebar__overlay--"+(c?"visible":"hidden")+"\n          ",onClick:this.closeSidebar,"aria-hidden":!0}),t.default.createElement("aside",{className:"onboarding-sidebar__sidebar",onClick:this.handleClickSidebar,onKeyDown:this.handleKeyDown,ref:this.setSidebarRef},t.default.createElement(n,o.__assign({isSidebarOpen:c,handleSuccess:this.handleSuccess,onboardingModules:this.renderOnboardingModules(),openSidebar:this.openSidebar,closeSidebar:this.closeSidebar,isCompleted:u,activeModuleIndex:a,setActiveModuleIndex:this.setActiveModuleIndex,onMouseEnter:this.handleMouseEnter,onMouseLeave:this.handleMouseLeave,isSidebarPeeking:r,onboardingSidebarActionTracker:this.onboardingSidebarActionTracker,openOnLoad:!!s,asyncLoadModulesInfo:this.asyncLoadModulesInfo},p))))},n})(t.default.Component);n.OnboardingSidebarComponent=I;var O={openOnboardingSidebar:c.openOnboardingSidebar,closeOnboardingSidebar:c.closeOnboardingSidebar},v=i.connect((function(e){return{isSidebarOpen:b.getIsOnboardingSidebarOpen(e),isSidebarHidden:b.getIsOnboardingSidebarHidden(e)}}),O)(I),y=l.getStoreForOnboardingSidebar();n.OnboardingSidebar=s.requireCssWithComponent((function(e){return t.default.createElement(i.Provider,{store:y},t.default.createElement(v,o.__assign({},e)))}),["/static/css/growth/onboarding_sidebar/onboarding_sidebar-vflf3OZ0r.css"]),n.RootComponent=function(e){return t.default.createElement(n.OnboardingSidebar,o.__assign({},e))}}));
//# sourceMappingURL=onboarding_sidebar.min.js-vflFazmQO.map
define(["require","exports","tslib","react","react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/comments2/data/api","modules/clean/react/css","classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","modules/clean/react_format","external/lodash","comments2/components/comment","comments2/components/comment_editor","comments2/components/comment_stream","comments2/components/comment_stream/comment_stream_error","comments2/components/coachmark_location","comments2/components/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/coachmark","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/components/util","modules/clean/react/comments2/util","modules/clean/react/comments2/data/logger","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/redux/types","modules/clean/react/comments2/data/mentions_api","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions"],(function(e,t,n,o,r,a,i,s,m,c,l,d,u,p,g,_,h,f,v,w,b,C,y,E,T,S,P,M,I,A,O,k,D,N,x,R,V,F){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),o=n.__importDefault(o),r=n.__importStar(r),i=n.__importStar(i),c=n.__importDefault(c),p=n.__importStar(p),S=n.__importStar(S),O=n.__importStar(O),k=n.__importStar(k);var U=["image_preview_surface","document_preview_surface","how_to_at_mention_comments_pane_surface"];function L(e,t){return void 0===t&&(t=1),e===x.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[n.__assign({page:t},T.createFullRectangle())]}:{type:"image",region:T.createFullRectangle()}}function q(e){var t=e.currentPageIndex,r=void 0===t?0:t,a=e.disabledTimeCodeTooltipComponent,i=e.playerCurrentTime,s=void 0===i?0:i,m=e.pendingNumberedAnnotation,c=e.previewType;if(c===x.PreviewType.Audio||c===x.PreviewType.Video){var l=c===x.PreviewType.Audio?"audio":"video";return o.default.createElement(_.TimeCodedCommentEditor,n.__assign({},e,{pendingAnnotation:{type:l,time:s},tooltipComponent:a}))}return c===x.PreviewType.SsrDoc||c===x.PreviewType.Image?o.default.createElement(_.NumberedCommentEditor,n.__assign({},e,{defaultAnnotation:L(c,r+1),pendingAnnotation:m})):o.default.createElement(_.CommentEditor,n.__assign({},e))}t.createDefaultNumberedAnnotation=L;var Q=(function(r){function s(t){var s=r.call(this,t)||this;return s.mentionsQueryId=0,s.onCommentStreamRef=function(e){return s.commentStream=e},s.updateMentionsMatches=function(e){s.setState({mentionsMatches:e})},s.logMentionsQueryCompletedPerf=function(e){var t=k.mentionsQueryCompleted();s.props.dispatch(I.Actions.logPerfEvent(t,e))},s.reloadComments=function(){s.props.dispatch(I.Actions.listComments(!0))},s.onMentionsQueryUpdated=function(e){if(e){var t=++s.mentionsQueryId;s.mentionsApi.query(e,s.updateMentionsMatches,k.withTiming(s.updateMentionsMatches,(function(e){s.mentionsQueryId===t&&s.logMentionsQueryCompletedPerf(e)})))}else""===e&&s.updateMentionsMatches(s.mentionsApi.getMatchesWithStarterSuggestions());s.props.dispatch(I.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},s.onPostSuccess=function(e,t){e.metadata&&e.metadata.some((function(e){return"mention"===e.type}))&&F.SharingActions.listMembers({user:t,contentId:s.props.stream.id,isFolder:!1,url:s.props.stream.linkUrl,includeSeenState:!1})},s.showEmailVerifyModal=function(e){if(!s.props.hasShownAnyModalVariant||e!==P.ShowModalReason.EditorFocus){s.props.dispatch(I.Actions.markModalVariantShown(P.ModalVariant.EmailVerifyModal)),S.logEvent("email_verify_modal_shown",{stream:s.props.stream});a.EmailVerification.get_for_user(s.props.viewer).show_verify_modal((function(){S.logEvent("email_verify_flow_completed",{stream:s.props.stream})}),i.ADD_COMMENT)}},s.showSignUpModal=function(t){if(!s.props.hasShownAnyModalVariant||t!==P.ShowModalReason.EditorFocus){s.props.dispatch(I.Actions.markModalVariantShown(P.ModalVariant.SignUpModal)),n.__awaiter(s,void 0,void 0,(function(){var t,r,a,i,s=this;return n.__generator(this,(function(m){switch(m.label){case 0:return[4,Promise.all([new Promise((function(t,n){e(["modules/clean/react/modal"],t,n)})).then(n.__importStar),new Promise((function(t,n){e(["modules/clean/auth/login_or_register/modal"],t,n)})).then(n.__importStar),new Promise((function(t,n){e(["modules/core/browser"],t,n)})).then(n.__importStar)])];case 1:return t=m.sent(),r=t[0].Modal,a=t[1].LoginOrRegisterModal,i=t[2],S.logEvent("sign_up_modal_shown",{stream:this.props.stream}),r.showInstance(o.default.createElement(a,{commentParams:{stream:this.props.stream,variant:d.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:d.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return i.reload()},onCancel:function(){return S.logEvent("sign_up_modal_dismissed",{stream:s.props.stream})},signup_tag:"comments_shmodel_modal_register"})),[2]}}))}))}},s.dismissImagePreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("image_preview_surface")},s.dismissDocumentPreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("document_preview_surface")},s.dismissHowToAtMentionOnoarding=function(){s.dismissOnboarding(),s.markOnboarded("how_to_at_mention_comments_pane_surface")},s.createComment=function(e){switch(s.props.previewType){case x.PreviewType.Video:case x.PreviewType.Audio:return o.default.createElement(g.TimeCodedComment,n.__assign({},e,{playerIntegrationEnabled:s.props.playerIntegrationEnabled}));case x.PreviewType.Image:case x.PreviewType.SsrDoc:return o.default.createElement(g.NumberedComment,n.__assign({},e));default:return o.default.createElement(g.Comment,n.__assign({},e))}},s.createEditor=function(e){var t=s.props,r=t.currentPageIndex,a=t.pendingNumberedAnnotation,i=t.playerCurrentTime,m=t.playerIntegrationEnabled,c=t.previewType,l=m?"target-annotation":"target-mention";return o.default.createElement(_.CoachMarkContainer,{className:l},o.default.createElement(q,n.__assign({},e,{disabledTimeCodeTooltipComponent:m?void 0:s.createDisabledTimeCodeTooltip,pendingNumberedAnnotation:a,currentPageIndex:r,playerIntegrationEnabled:m,playerCurrentTime:i,previewType:c})))},s.createDisabledTimeCodeTooltip=function(e){return o.default.createElement(V.DisabledTimeCodeTooltip,n.__assign({},e,{onClick:s.onDisabledTooltipLearnMoreClick,onShow:s.onDisabledTooltipShow}))},s.onDisabledTooltipLearnMoreClick=function(){return S.logEvent("time_based_tooltip_learn_more_click",{stream:s.props.stream})},s.onDisabledTooltipShow=function(){return S.logEvent("time_based_tooltip_learn_more_view",{stream:s.props.stream})},s.markOnboarded=function(e){s.props.dispatch(I.Actions.markOnboarded(e))},s.dismissOnboarding=function(){s.props.dispatch(I.Actions.dismissOnboarding(null))},s.mentionsApi=N.mentionsApi(t.viewer),s.state={mentionsMatches:s.mentionsApi.cache},s}return n.__extends(s,r),s.prototype.componentDidMount=function(){var e=this.props,t=e.dispatch,n=e.showOnboarding,o=e.perfEvents,r=e.stream,a=+new Date;S.logEvent("show_comments",{stream:r}),t(I.Actions.logSimplePerfEvent("stream_displayed_ms",a-(o.listCompleteTime||0))),t(I.Actions.logSimplePerfEvent("comment_editor_tti_ms",a-(o.setContextTime||0))),n&&S.logEvent("sidebar_onboarding_shown",{stream:r})},s.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,n=e.showOnboarding,o=this.props,r=o.showOnboarding,a=o.dispatch,i=o.requestEditorFocus,s=o.stream;!n&&r&&S.logEvent("sidebar_onboarding_shown",{stream:s}),!t&&i&&(this.commentStream.focusPrimaryEditor(),a(I.Actions.fulfillEditorFocusRequest()))},Object.defineProperty(s.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return p.difference(this.props.relevantOnboardingKeys,U)},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"imagePdfCoachmarkData",{get:function(){var e=this,t=this.props,r=t.showOnboarding,a=t.relevantOnboardingKeys,i=l._("Animation of annotating a file",{comment:"This is alt text for an animated gif"}),s=r&&p.head(p.intersection(U,a)),m={title:o.default.createElement("h2",{className:"sc-coachmark-title"}),body:o.default.createElement("p",null)};switch(s){case"document_preview_surface":return{location:v.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(C.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissDocumentPreviewSurfaceOnboarding}),o.default.createElement(E.Comments2OnboardingImage,{fileNamePrefix:"02_Comments2_PDFComments","aria-label":i}),u.reactFormat(l._("<title>Call it out</title> <body>Select an area on the file to highlight and comment.</body>"),m))}};case"image_preview_surface":return{location:v.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return o.default.createElement(C.CommentsCoachmark,n.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissImagePreviewSurfaceOnboarding}),o.default.createElement(E.Comments2OnboardingImage,{fileNamePrefix:"01_Comments2_ImageComment","aria-label":i}),u.reactFormat(l._("<title>Call it out</title> <body>Select an area on the image to highlight and comment.</body>"),m))}};case"how_to_at_mention_comments_pane_surface":return{location:v.CoachmarkLocations.ABOVE_COMMENT_STREAM,target:v.CoachmarkTargets.MAIN_EDITOR_MENTION_BUTTON,component:function(t){return o.default.createElement(C.CommentsCoachmark,n.__assign({},t,{onClose:e.dismissHowToAtMentionOnoarding}),o.default.createElement(E.Comments2OnboardingImage,{fileNamePrefix:"03_Comments_AtMentions_v1","aria-label":l._("Animation of mentioning a user",{comment:"This is alt text for an animated gif"})}),u.reactFormat(l._("<title>Get the feedback you need</title> <body>Tag someone to work together on this file.</body>"),m))}};default:return}},enumerable:!0,configurable:!0}),Object.defineProperty(s.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return b.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!0,configurable:!0}),s.prototype.stickerSetsToStickerPacks=function(e){return e.map((function(e){return{url:e.url,stickers:e.stickers,description:e.description,name:e.name,id:e.set_id}}))},s.prototype.render=function(){var e,n=this.props,r=n.activeThreadId,a=n.collapsed,i=n.dispatch,s=n.editorIsEmpty,m=n.focusedThreadId,l=n.hoverThreadId,d=n.isMobile,u=n.showResolved,p=n.showCommentsError,g=(n.showCommentsErrorIsPermissionsProblem,n.stream.id),_=n.thirdPartySource,v=n.threads,b=n.viewer,C=n.previewType,E=n.streamSettings,S=n.stickers,P=n.upsellTooltipVariant,I=v.filter((function(e){return u||!e.resolvedInfo}));e=b?M.dbxUserToIUser(b):w.getGuestIUser();var A=C===x.PreviewType.Image||C===x.PreviewType.SsrDoc,O=p&&o.default.createElement(f.CommentStreamError,{intl:R.comments2Intl,onClickRetry:this.reloadComments});return o.default.createElement("div",{className:c.default("comments-pane-wrapper",{"no-comment":d&&0===I.length,"comments-pane-wrapper-show-resolved":u,"comments-pane-wrapper-hide-resolved":!u,"comments-pane-wrapper-all-changes-saved":!v.some((function(e){return!!e.pending})),"comments-upsell-eligible":!!P,"comments-upsell-ineligible":!P})},d&&o.default.createElement(t.MobileCommentsTitle,{commentCount:I.length}),O,o.default.createElement(h.CommentStream,{ref:this.onCommentStreamRef,id:g,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:d,mentionsMatches:this.state.mentionsMatches,settings:E,threads:I,user:e,activeThreadID:r,focusedThreadID:m,hoverThreadID:l,showUnreadPill:T.canShowUnreadPill(),localization:R.commentsMasterLocalization,collapsed:a,coachmarkData:this.imagePdfCoachmarkData,showRevisionInfo:A,stickerPacks:S&&this.stickerSetsToStickerPacks(S),thirdPartySource:_}),o.default.createElement(y.SidebarListener,{dispatch:i,editorIsEmpty:s,stream:this.props.stream}))},s})(o.default.Component);t.CommentsPaneComponent=Q,t.MobileCommentsTitle=function(e){return o.default.createElement("div",{className:"comments-pane-wrapper__mobile-comments-title"},l._("Comments · %(count)d",{comment:"Title shown on top of web previews comments, indicating the number of comment threads"}).format({count:e.commentCount}))};var K=r.connect((function(e){var t=O.getContext(e),n=t.stream,o=t.viewer,r=O.getData(e),a=r.perfEvents,i=r.upsellExperimentNotDismissed,m=r.upsellTooltipVariant,c=O.getListCommentsError(e),l=c instanceof s.Comments2Error&&c.code===s.ErrorCode.PERMISSION_DENIED;return{activeThreadId:O.getActivatedThreadId(e),editorIsEmpty:O.getEditorIsEmpty(e),focusedThreadId:O.getFocusedThreadId(e),hasShownAnyModalVariant:O.getHasShownAnyModalVariant(e),hoverThreadId:O.getHoverThreadId(e),playerCurrentTime:O.getPlayerCurrentTime(e),playerIntegrationEnabled:O.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:O.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:O.getShowOnboardingOnCommentsPane(e),showResolved:O.getShowResolved(e),pendingNumberedAnnotation:O.getPendingNumberedAnnotation(e),previewType:O.getPreviewTypeForCurrentFile(e),currentPageIndex:A.getCurrentPageIndex(e),showUpsellExperiment:!!o&&i,showCommentsError:O.getStatuses(e)[I.ActionTypes.ListComments.name]===D.ApiClientStatus.Error,showCommentsErrorIsPermissionsProblem:l,stream:n,thirdPartySource:O.getThirdPartySource(e),threads:O.getThreads(e),viewer:o,upsellTooltipVariant:m,perfEvents:a,requestEditorFocus:O.getIsEditorFocusRequested(e),streamSettings:O.getStreamSettings(e),stickers:O.getStickers(e)}}))(Q);t.CommentsPane=m.requireCssWithComponent(K,["/static/js/comments2/index.web-vflR1iBYg.css","/static/css/comments2-vflmLfLER.css","/static/css/snackbar-vfl8chDI1.css"])}));
//# sourceMappingURL=comments_pane.min.js-vfldarqT_.map
define(["require","exports","tslib","jquery","react","classnames","modules/clean/react/prompt/prompt_location","modules/clean/react/prompt/button","modules/clean/animation","modules/clean/upsell/upsell_controller","modules/clean/react/css","modules/clean/react/sprite","modules/clean/react/prompt/image","modules/clean/static_urls","modules/core/i18n"],(function(e,t,a,n,o,r,s,i,l,u,c,p,d,b,m){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n=a.__importDefault(n),o=a.__importDefault(o),r=a.__importDefault(r),u=a.__importDefault(u);var f=20,g=-20,h=39,v=-39,B=(function(e){function t(t,s){var c=e.call(this,t,s)||this;return c.getTargetedElement=function(){return n.default(c.props.campaign.content.targetSelector).first()},c.isTargetedElementVisible=function(){var e=c.getTargetedElement();return e.length>0&&e.is(":visible")},c.isTargetInDocument=function(e){return document.body.contains(e[0])},c.getPromptSilo=function(){return n.default("#prompt-silo")},c.waitForElementThenSetupAndPosition=function(e){void 0===e&&(e=Date.now()),c.isTargetedElementVisible()?c.setupControlsAndPositionBubble():setTimeout((function(){return c.waitForElementThenSetupAndPosition(e)}),200)},c.baseOnClick=function(e){null!=c.repositioner&&c.repositioner.stop(),c.setState({isShown:!1}),void 0!==c.$backdropElements&&c.$backdropElements.backdrop.remove(),c.$allJQueryButtons&&c.$allJQueryButtons.off("click",c.jqueryOnClickHandler)},c.jqueryOnClickHandler=function(e){c.baseOnClick(e),"#"===n.default(e.currentTarget).attr("href")&&e.preventDefault()},c.onConfirm=function(e){c.state_manager.onConfirm(e),c.baseOnClick(e)},c.onDismiss=function(e){c.state_manager.onDismiss(e),c.baseOnClick(e)},c.buildUpsellControllerOptions=function(){return a.__assign(a.__assign(a.__assign({},c.props),c.props.campaign),c.props.campaign.content)},c.setupControlsAndPositionBubble=function(){var e,t=c.getTargetedElement(),a=t;c.props.campaign.content.hasBackdrop&&(c.$backdropElements=c.setupAndPositionBackdrop(t),a=a.add(c.$backdropElements.backdropHole),e=c.$backdropElements.backdrop),e=e||n.default(),new u.default(a,e,c.buildUpsellControllerOptions()),c.$allJQueryButtons=a.add(e),c.$allJQueryButtons.on("click",c.jqueryOnClickHandler),c.state_manager.onShow(),c.setState({},(function(){var e=t;c.props.campaign.content.hasBackdrop&&c.$backdropElements&&(e=c.$backdropElements.backdropHole);var a=function(){return c.setState({targetedBubbleWrapperZIndex:c._elementZIndex(e)+1}),c.positionBubbleAbsolute(e)};if(a(),!c.props.campaign.content.hasBackdrop)return c.repositioner=new l.RenderAtFps(a,60),c.repositioner.start()}))},c.isTargetFixed=function(e){return e.parents().filter((function(){return"fixed"===n.default(this).css("position")})).length>0},c.getTargetedBubbleImage=function(){var e=c.props.campaign.content,t=e.confirmText,a=e.imageUrl;if(a)return o.default.createElement("div",{className:"targeted-bubble__image"},o.default.createElement("img",{className:"image",src:a,alt:t||void 0}))},c.getBubbleWrapperClassName=function(){var e={"targeted-bubble-wrapper":!0};return c.props.isPreview?(e.active=!0,e.static=!0,r.default(e)):(e.active=c.state.isShown,r.default(e))},c._elementZIndex=function(e){for(;e.length&&e[0]!==document;){var t=e.css("position");if(["absolute","relative","fixed"].includes(t)){var a=parseInt(e.css("zIndex"),10);if(!isNaN(a)&&0!==a)return a}e=e.parent()}return 0},c._elementDocumentRelativeRect=function(e){var t=e.getBoundingClientRect(),a=window.pageXOffset,n=window.pageYOffset;return{top:t.top+n,left:t.left+a,width:t.width,height:t.height}},c.positionBubbleAbsolute=function(e){if(c.props.campaign.content.hasBackdrop||(e=c.getTargetedElement()),!c.isTargetInDocument(e)||!c.targetedBubbleWrapperRef.current)return c.setState({isShown:!1}),void(null!=c.repositioner&&c.repositioner.stop());var t=c.props.campaign.content.placement,a=c._elementDocumentRelativeRect(e[0]),o=c.targetedBubbleWrapperRef.current.getBoundingClientRect().height,r=c.getPositionTop(t,a,o),s=n.default(window).height();if(r+o-window.pageYOffset>s){var i=r-o-2*v;i>0&&"bottom"!==t&&"top"!==t?(r=i,c.setState({addBottomRelativeClassToTargetedBubble:!0})):c.setState({addBottomRelativeClassToTargetedBubble:!1})}else c.setState({addBottomRelativeClassToTargetedBubble:!1});var l=c.targetedBubbleWrapperRef.current.getBoundingClientRect().width,u=c.getPositionLeft(t,a,l);c.setState({bubbleWrapperTopLeft:{top:r,left:u}})},c.setupAndPositionBackdrop=function(e){n.default(".targeted-bubble-backdrop__hole, .targeted-bubble-backdrop").remove();var t=n.default("<div></div>").addClass("targeted-bubble-backdrop__hole"),a=n.default("<div></div>").addClass("targeted-bubble-backdrop").append(t);c.getPromptSilo().append(a);var o=e.offset();return t.css({boxShadow:"rgba(0, 0, 0, 0.6) 0 0 0 30000px, inset 0 0 0 #111",width:e.outerWidth(),height:e.outerHeight(),position:c.isTargetFixed(e)?"fixed":"absolute",cursor:e.css("cursor")}),t.offset(o),{backdrop:a,backdropHole:t}},c.getButtonClassName=function(){return c.props.campaign.content.imageUrl?void 0:"small-margin"},c.getBubbleWrapperStyle=function(){return{zIndex:c.state.targetedBubbleWrapperZIndex,top:c.state.bubbleWrapperTopLeft?c.state.bubbleWrapperTopLeft.top:void 0,left:c.state.bubbleWrapperTopLeft?c.state.bubbleWrapperTopLeft.left:void 0}},c.getBubbleClassName=function(){var e=c.props.campaign.content,t=e.placement,a=e.colorStyle;return r.default({"chat-bubble":!0,"targeted-bubble":!0,"chat-bubble-top":null!==t&&("bottom"===t||"bottom-right"===t),"chat-bubble-right":null!==t&&"left"===t,"chat-bubble-left":null===t||"right"===t,"chat-bubble-bottom":null!==t&&"top"===t,"bottom-relative":c.state.addBottomRelativeClassToTargetedBubble,"with-x-icon":c.props.campaign.content.cancelWithXIcon,"without-x-icon":!c.props.campaign.content.cancelWithXIcon,dark:"dark"===a})},c.getExtraArrowClassNames=function(e){var t={black:"dark"===c.props.campaign.content.colorStyle,"left-arrow":"bottom-right"===c.props.campaign.content.placement};return t[e]=!0,r.default(t)},c.getPositionLeft=function(e,t,a){return"top"===e||"bottom"===e?t.left+Math.floor(t.width/2)-a+h:"bottom-right"===e?t.left+Math.floor(t.width/2)+g:"left"===e?g-a+t.left:-g+t.width+t.left},c.getPositionTop=function(e,t,a){return"bottom"===e||"bottom-right"===e?t.top+t.height+f:"top"===e?t.top-(a+f):v+t.top+Math.floor(t.height/2)},c.onDismissIconClick=function(e){c.props.isPreview||(c.setState({isShown:!1}),c.state_manager.onDismiss(e))},c.renderDismissButtonSprite=function(){return"dark"===c.props.campaign.content.colorStyle?o.default.createElement(d.Image,{src:b.static_url("/static/images/top-notification-x-white-vflCh9Pt1.svg"),alt:m._("Close")}):o.default.createElement(p.Sprite,{group:"web",name:"close_small",alt:m._("Close")})},c.renderDismissButton=function(){return c.props.campaign.content.cancelWithXIcon?o.default.createElement(i.DismissButton,{className:"close-button dismiss-x-icon",onDismiss:c.onDismissIconClick,"aria-label":m._("Close")},c.renderDismissButtonSprite()):null},s=a.__assign(a.__assign({},s),{addBottomRelativeClassToTargetedBubble:!1,bubbleWrapperTopLeft:void 0}),c.targetedBubbleWrapperRef=o.default.createRef(),c}return a.__extends(t,e),t.prototype.componentDidMount=function(){this.props.isPreview||this.waitForElementThenSetupAndPosition()},t.prototype.render=function(){var e=this.props.campaign.content,t=e.header,a=e.text,n=t?o.default.createElement("h2",{className:"title"},t):null;return o.default.createElement("div",{className:this.getBubbleWrapperClassName(),style:this.getBubbleWrapperStyle(),ref:this.targetedBubbleWrapperRef},o.default.createElement("div",{className:this.getBubbleClassName()},this.getTargetedBubbleImage(),n,o.default.createElement("span",{className:"targeted-bubble__text"},a),o.default.createElement(i.PromptButtons,{campaign:this.props.campaign,confirmIsPost:this.state_manager.shouldConfirmUsingPost(),confirmUrl:this.state_manager.buildConfirmEndpointURI(),onConfirm:this.onConfirm,onDismiss:this.onDismiss,confirmButtonClassName:this.getButtonClassName(),dismissButtonClassName:this.getButtonClassName()}),this.renderDismissButton(),o.default.createElement("div",{className:this.getExtraArrowClassNames("chat-bubble-arrow-border")}),o.default.createElement("div",{className:this.getExtraArrowClassNames("chat-bubble-arrow")})))},t.displayName="TargetedBubbleWithoutCSS",t})(s.PromptLocation);t.TargetedBubbleRendererWithoutCSS=B,t.TargetedBubble=c.requireCssWithComponent(B,["/static/css/upsell/targeted_bubble-vfl3ZgQz0.css","/static/css/chatbubble-vflAxqf1H.css"])}));
//# sourceMappingURL=targeted_bubble.min.js-vflRrfWQ_.map
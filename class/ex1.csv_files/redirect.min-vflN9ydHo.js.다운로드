define(["require","exports","tslib","modules/clean/ajax","external/lodash","modules/core/i18n","modules/clean/web_timing_logger","modules/core/cookies","modules/core/notify","modules/core/uri","modules/clean/api_v2/transport/jquery","modules/clean/react/modal","modules/clean/react/extensions/auth_modal","modules/clean/filepath","modules/clean/react/extensions/cloud_docs_compat","modules/clean/cloud_docs/event_logging","modules/clean/cloud_docs/open_with_utils"],(function(e,t,r,i,n,o,a,s,c,u,d,l,_,h,f,m,p){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),i=r.__importStar(i),n=r.__importStar(n),h=r.__importStar(h);function w(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,o,a,c;return r.__generator(this,(function(r){if(n=new d.JQueryAsyncTransport,o=new u.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),(a={})["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),a["X-Dropbox-Uid"]=e.id.toString(),!(c=s.Cookies.read("__Host-js_csrf")))throw new Error("No CSRF cookie");return(a["X-CSRF-Token"]=c,[2,n.executeRpc(o,a,JSON.stringify(i),"application/json")])}))}))}function g(e,t,i){return r.__awaiter(this,void 0,void 0,(function(){var n,o;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,w(e,t,i)];case 1:return n=r.sent(),o={request_id:n.headers["x-dropbox-request-id"],redirect_url:n.result.redirect_url},"link_state"in n.result&&(o.link_state=n.result.link_state),[2,o]}}))}))}function v(e,t,i,n,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,b(e,t,i,n,(function(){return g(e,"redirect",{action_id:t,file_id:n})}),o)];case 1:return r.sent(),[2]}}))}))}function x(e,t,i,n,o){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(r){switch(r.label){case 0:return[4,b(e,t,i,n,(function(){return g(e,"authorize",{action_id:t,file_id:n})}),o)];case 1:return[2,r.sent()]}}))}))}function b(e,t,s,u,d,l){return r.__awaiter(this,void 0,Promise,(function(){function _(){return r.__awaiter(this,void 0,void 0,(function(){return r.__generator(this,(function(e){switch(e.label){case 0:return e.trys.push([0,2,,3]),[4,d()];case 1:return[2,e.sent()];case 2:return e.sent(),w=!0,[2,void 0];case 3:return[2]}}))}))}var h,f,m,p,w,g,v,x,b,k;return r.__generator(this,(function(r){switch(r.label){case 0:return a.delete_timer("extensions_redirect_handoff"),h=a.get_timer("extensions_redirect_handoff"),f=t&&t.startsWith("fp_action_id:")?"extensions_shortcut_handoff":"extensions_redirect_handoff",h.initialize({requireTTI:!0,requireTTV:!1,url:f}),m="action_redirect_"+Math.random().toString(16).substring(2),(p=window.open("",m,l))&&(p.document.open("text/html","replace"),p.document.write("<html><head><title>"+n.escape(s)+"</title></head></html>"),p.document.close()),w=!1,g=new Promise((function(r){i.SilentBackgroundRequest({url:"/aa/loading",subject_user:e.id,data:{file_id:u,action_id:t},success:function(e){!w&&p?(p.document.open("text/html","replace"),p.document.write(e),p.document.close(),p.document.title=s,r()):r()},error:function(){r()}})})),[4,Promise.all([g,_()])];case 1:return v=r.sent(),x=v[1],b=x&&x.redirect_url||"/aa/error",p?p.location.replace(b):window.open(b,"_blank",l)||(k=s,c.Notify.error(o._("Failed to open %(app_name)s").format({app_name:k}))),x&&x.request_id&&(h.markTimeToInteractive(),h.end(x.request_id)),[2,x]}}))}))}t.fetch=w,t.fetchUrl=g,t.authorizeNoRedirect=function(e,t){return r.__awaiter(this,void 0,void 0,(function(){var i;return r.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,w(e,"authorize_no_redirect",{action_id:t})];case 1:return[2,(i=r.sent())&&i.result&&i.result.link_state];case 2:return r.sent(),[2,null];case 3:return[2]}}))}))},t.redirectToAction=v,t.redirectToActionOrShowAuth=function(e,t,i,n,o,a,s){return r.__awaiter(this,void 0,void 0,(function(){var n,c,u,d,w,g,b;return r.__generator(this,(function(k){if("redirect"===i.handler[".tag"])n=i.handler.window_params,c=void 0,"popup"===n[".tag"]&&(u=n.width,d=n.height,c="width="+u+",height="+d),"sfa_unlinked"===i.link_state[".tag"]&&!i.id.startsWith("fp_action_id:")?(w=h.filename(t.ns_path),_.showAuthModal(i.id,i.description,i.icon.url,t.file_id,w,(function(){l.Modal.close(),(function(e,t,i,n,o,a){r.__awaiter(this,void 0,void 0,(function(){var s;return r.__generator(this,(function(r){switch(r.label){case 0:return[4,x(e,t,i,n,o)];case 1:return s=r.sent(),a&&s&&s.link_state&&a(t,s.link_state),[2]}}))}))})(e,i.id,i.description,t.file_id,c,a)}))):v(e,i.id,i.description,t.file_id,c);else if("cloud_editor"===i.handler[".tag"])g=o?m.getActionSourceFromSurface(o.surface):void 0,b=f.cloudEditorNameToParams(i.handler.editor_name),p.openWithCloudEditor(t,e,b,!1,g);else{if("profile_service"!==i.handler[".tag"])throw new Error('Unexpected handler "'+i.handler[".tag"]+'"');s&&s(e,t,i)}return[2]}))}))},t.authAction=x,t.showLoadingPageAndDoRedirect=b}));
//# sourceMappingURL=redirect.min.js-vfl-OdqtN.map